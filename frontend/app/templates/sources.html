<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="/static/style.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <title>Источники</title>
    <style>
    body { font-family: 'Inter', sans-serif; line-height: 1.5; margin: 0; padding: 0; background: #f9fafb; color: #222; margin-bottom: 60px; }
    .container { max-width: 1200px; margin: 0 auto; padding: 1em 2em; }
    
    .navbar { background: #fff; box-shadow: 0 2px 8px rgba(0,0,0,0.03); padding: 0.7em 0; position: sticky; top: 0; z-index: 1000; }
    .navbar-content { display: flex; align-items: center; max-width: 1200px; margin: 0 auto; padding: 0 2em; }
    .navbar-brand { font-size: 1.6em; font-weight: 700; margin-right: 2em; color: #111; text-decoration: none; line-height: 1; }
    .navbar-links { display: flex; gap: 1.5em; flex: 1; justify-content: center; }
    .nav-link { color: #222; text-decoration: none; font-size: 1.08em; padding: 0.2em 0.5em; border-radius: 4px; transition: background 0.15s; }
    .nav-link.active, .nav-link:hover { color: #2563eb; background: #f2f6ff; }
    
    .btn-primary { 
        display: inline-block;
        padding: 0.6em 1.2em;
        background: #2563eb; 
        color: #fff; 
        border: none; 
        border-radius: 6px; 
        font-size: 0.9em; 
        font-weight: 500; 
        cursor: pointer; 
        transition: background 0.15s;
        text-decoration: none;
    }
    .btn-primary:hover { background: #1d4ed8; }
    
    .btn-logout {
        display: inline-block;
        padding: 0.6em 1.2em;
        background: #f3f4f6;
        color: #374151;
        border: none;
        border-radius: 6px;
        font-size: 0.9em;
        font-weight: 500;
        cursor: pointer;
        transition: background 0.15s;
        text-decoration: none;
        margin-left: 1em;
    }
    .btn-logout:hover { background: #e5e7eb; }
    
    .page-header { margin: 2em 0 1.5em 0; }
    .page-title { font-size: 1.8em; margin-bottom: 0.5em; color: #111; }
    .page-description { font-size: 1.05em; color: #4b5563; margin-bottom: 1.5em; }
    
    .sources-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        gap: 1.5em;
        margin-top: 2em;
    }
    
    .source-card {
        background: white;
        border-radius: 8px;
        overflow: hidden;
        box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        transition: transform 0.15s, box-shadow 0.15s;
        height: 100%;
        display: flex;
        flex-direction: column;
    }
    
    .source-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 3px 10px rgba(0,0,0,0.1);
    }
    
    .source-header {
        padding: 1.2em;
        border-bottom: 1px solid #f3f4f6;
        background: #f9fafb;
    }
    
    .source-title {
        font-size: 1.2em;
        font-weight: 600;
        margin-bottom: 0.5em;
        color: #111;
    }
    
    .source-author {
        font-size: 0.95em;
        color: #6b7280;
    }
    
    .source-content {
        padding: 1.2em;
        flex: 1;
        display: flex;
        flex-direction: column;
    }
    
    .source-details {
        font-size: 0.9em;
        color: #6b7280;
        margin-bottom: 1em;
    }
    
    .source-detail-item {
        margin: 0.3em 0;
        display: flex;
    }
    
    .source-detail-label {
        font-weight: 500;
        min-width: 100px;
    }
    
    .source-annotation {
        margin-top: 1em;
        font-size: 0.9em;
        color: #374151;
        line-height: 1.6;
    }
    
    .source-actions {
        margin-top: auto;
        padding-top: 1em;
        display: flex;
        justify-content: space-between;
    }
    
    .btn-view {
        display: inline-block;
        padding: 0.4em 0.8em;
        background: #f3f4f6;
        color: #374151;
        border: none;
        border-radius: 4px;
        font-size: 0.9em;
        text-decoration: none;
        transition: background 0.15s;
    }
    .btn-view:hover { background: #e5e7eb; }
    
    .btn-delete {
        display: inline-block;
        padding: 0.4em 0.8em;
        background: #fee2e2;
        color: #b91c1c;
        border: none;
        border-radius: 4px;
        font-size: 0.9em;
        cursor: pointer;
        transition: background 0.15s;
    }
    .btn-delete:hover { background: #fecaca; }
    
    .add-source-form {
        background: white;
        border-radius: 8px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        padding: 1.5em;
        margin-bottom: 2em;
        display: none;
    }
    
    .form-title {
        font-size: 1.3em;
        font-weight: 600;
        margin-bottom: 1em;
        color: #111;
    }
    
    .form-row {
        display: flex;
        gap: 1.5em;
        margin-bottom: 1.2em;
    }
    
    .form-group {
        flex: 1;
    }
    
    .form-label {
        display: block;
        font-weight: 500;
        margin-bottom: 0.5em;
        color: #374151;
    }
    
    .form-control {
        width: 100%;
        padding: 0.7em;
        font-size: 1em;
        border: 1px solid #d1d5db;
        border-radius: 6px;
        background: #fff;
    }
    
    .form-control:focus {
        outline: none;
        border-color: #2563eb;
        box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.2);
    }
    
    .form-actions {
        margin-top: 1.5em;
        display: flex;
        justify-content: flex-end;
        gap: 1em;
    }
    
    .btn-cancel {
        display: inline-block;
        padding: 0.6em 1.2em;
        background: #f3f4f6;
        color: #374151;
        border: none;
        border-radius: 6px;
        font-size: 0.9em;
        font-weight: 500;
        cursor: pointer;
        transition: background 0.15s;
    }
    .btn-cancel:hover { background: #e5e7eb; }
    
    .error-message {
        color: #b91c1c;
        font-size: 0.9em;
        margin-top: 0.5em;
    }
    
    .no-sources {
        text-align: center;
        padding: 3em 1em;
        color: #6b7280;
    }
    
    footer { background: #111; color: #fff; text-align: center; padding: 1.2em 0 1em 0; font-size: 1em; position: fixed; left: 0; right: 0; bottom: 0; z-index: 100; letter-spacing: 0.02em; }
    
    @media (max-width: 768px) {
        .navbar-links {
            display: none;
        }
        
        .form-row {
            flex-direction: column;
            gap: 1em;
        }
        
        .sources-grid {
            grid-template-columns: 1fr;
        }
    }
    
    .search-input-container {
        display: flex;
        gap: 0.5em;
        position: relative;
        align-items: center;
        margin-bottom: 0.5em;
    }
    .search-input {
        flex: 1;
        padding: 0.7em 2.2em 0.7em 2.2em;
        border: 1px solid #d1d5db;
        border-radius: 6px;
        font-size: 1em;
        background: #fff;
        transition: border 0.2s, box-shadow 0.2s;
    }
    .search-input:focus {
        outline: none;
        border-color: #2563eb;
        box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.15);
    }
    .search-button {
        padding: 0.7em 1.5em;
        background: #2563eb;
        color: #fff;
        border: none;
        border-radius: 6px;
        font-size: 0.95em;
        font-weight: 500;
        cursor: pointer;
        transition: background 0.15s;
    }
    .search-button:hover {
        background: #1d4ed8;
    }
    .user-role-badge {
        display: inline-flex;
        align-items: center;
        background: #f2f6ff;
        color: #2563eb;
        border-radius: 6px;
        font-size: 1em;
        font-weight: 500;
        padding: 0.3em 0.8em;
        margin-left: 1em;
        box-shadow: 0 1px 3px rgba(37,99,235,0.07);
    }
    </style>
</head>
<body>
    {% if user_role %}
    <span class="user-role-badge-fixed">
        <svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" style="vertical-align:middle;margin-right:4px;"><circle cx="12" cy="12" r="10"/><text x="12" y="16" text-anchor="middle" font-size="10" fill="#2563eb">{{ user_role|capitalize }}</text></svg>
        <span>{{ user_role|capitalize }}</span>
    </span>
    {% endif %}
    <nav class="navbar">
        <div class="navbar-content">
            <a href="/" class="navbar-brand">Каталог<br>Асан</a>
            <div class="navbar-links">
                <a href="/asanas" class="nav-link">Каталог асан</a>
                <a href="/sources" class="nav-link active">Источники</a>
                {% if is_admin %}
                <a href="/settings" class="nav-link">Настройки</a>
                {% endif %}
                <a href="/about" class="nav-link">О проекте</a>
                <a href="/expert-instructions" class="nav-link">Инструкции</a>
            </div>
            <div class="navbar-actions" id="navbar-actions">
                {% if is_expert_or_admin %}
                    <a href="/asana/add" class="btn-primary">Добавить асану</a>
                    <a href="/sources/add" class="btn-primary" style="margin-left: 10px;">Добавить источник</a>
                {% endif %}
                {% if is_authenticated %}
                    <a href="/logout" class="btn-logout"><span style="font-size:1.1em;">⎋</span> Выйти</a>
                {% else %}
                    <a href="/login" class="btn-primary">Войти</a>
                {% endif %}
            </div>
        </div>
    </nav>
    
    <div class="container">
        <div class="page-header">
            <h1 class="page-title">Источники</h1>
            <p class="page-description">Список источников с описаниями и асанами.</p>
            
            <!-- Форма поиска -->
            <div class="search-form-container">
                <form id="search-form" class="search-form">
                    <div class="search-input-container">
                        <input type="text" id="search-query" name="query" placeholder="Поиск источников..." class="search-input" style="padding-left:2.2em;">
                        <span style="position:absolute;left:12px;top:50%;transform:translateY(-50%);color:#bdbdbd;font-size:1.2em;pointer-events:none;">
                            <svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
                        </span>
                        <button type="submit" class="search-button">Найти</button>
                    </div>
                </form>
            </div>
        </div>
        
        <div class="sources-grid">
            {% for source in sources %}
            <div class="source-card">
                <div class="source-header">
                    <h2 class="source-title">{{ source.title }}</h2>
                    <div class="source-author">{{ source.author }}</div>
                </div>
                
                <div class="source-content">
                    <div class="source-details">
                        <div class="source-detail-item">
                            <span class="source-detail-label">Издательство:</span>
                            <span>{{ source.publisher }}</span>
                        </div>
                        <div class="source-detail-item">
                            <span class="source-detail-label">Год издания:</span>
                            <span>{{ source.year }}</span>
                        </div>
                        {% if source.pages %}
                        <div class="source-detail-item">
                            <span class="source-detail-label">Страниц:</span>
                            <span>{{ source.pages }}</span>
                        </div>
                        {% endif %}
                    </div>
                    
                    {% if source.annotation %}
                    <div class="source-annotation">
                        {{ source.annotation }}
                    </div>
                    {% endif %}
                    
                    <div class="source-actions">
                        <a href="/sources/{{ source.id.split('#')[-1].replace('source_', '') }}/asanas" class="btn-view">Посмотреть асаны</a>
                        {% if is_expert_or_admin %}
                        <button class="btn-delete delete-source" data-id="{{ source.id }}" data-title="{{ source.title }}">Удалить</button>
                        {% endif %}
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    
    <footer>
        © {{ year }} Каталог асан
    </footer>
    
    <script>
    // Функция для проверки авторизации
    async function checkAuth() {
        try {
            const response = await fetch('/api/auth/check');
            const data = await response.json();
            return {
                isAuthenticated: data.is_authenticated,
                userRole: data.role
            };
        } catch (error) {
            console.error('Error checking auth:', error);
            return {
                isAuthenticated: false,
                userRole: null
            };
        }
    }

    // Обработка отправки формы поиска
    document.getElementById('search-form')?.addEventListener('submit', function(e) {
        e.preventDefault();
        
        const query = document.getElementById('search-query').value.trim();
        if (!query) {
            return;
        }

        // Выполняем поиск через API
        fetch(`/api/sources/search?query=${encodeURIComponent(query)}`)
            .then(response => response.json())
            .then(data => {
                // Обновляем содержимое страницы с результатами
                const container = document.querySelector('.sources-grid');
                container.innerHTML = ''; // Очищаем текущее содержимое
                
                if (data.length === 0) {
                    container.innerHTML = '<div class="no-sources"><p>Источники не найдены</p></div>';
                    return;
                }
                
                // Добавляем найденные источники
                data.forEach(source => {
                    // Извлекаем короткий ID из полного URI
                    const sourceShortId = source.id.split('#').pop();
                    
                    container.innerHTML += `
                        <div class="source-card">
                            <div class="source-header">
                                <h2 class="source-title">${source.title}</h2>
                                <div class="source-author">${source.author}</div>
                            </div>
                            
                            <div class="source-content">
                                <div class="source-details">
                                    <div class="source-detail-item">
                                        <span class="source-detail-label">Издательство:</span>
                                        <span>${source.publisher || ''}</span>
                                    </div>
                                    <div class="source-detail-item">
                                        <span class="source-detail-label">Год издания:</span>
                                        <span>${source.year}</span>
                                    </div>
                                    ${source.pages ? `
                                    <div class="source-detail-item">
                                        <span class="source-detail-label">Страниц:</span>
                                        <span>${source.pages}</span>
                                    </div>
                                    ` : ''}
                                </div>
                                
                                ${source.annotation ? `
                                <div class="source-annotation">
                                    ${source.annotation}
                                </div>
                                ` : ''}
                                
                                <div class="source-actions">
                                    <a href="/sources/${sourceShortId}/asanas" class="btn-view">Посмотреть асаны</a>
                                    ${window.isExpertOrAdmin ? `
                                    <button class="btn-delete delete-source" data-id="${source.id}" data-title="${source.title}">Удалить</button>
                                    ` : ''}
                                </div>
                            </div>
                        </div>
                    `;
                });
            })
            .catch(error => {
                console.error('Error searching sources:', error);
                alert('Ошибка при поиске источников');
            });
    });

    // При загрузке страницы
    document.addEventListener('DOMContentLoaded', async function() {
        // Проверяем авторизацию
        const { isAuthenticated, userRole } = await checkAuth();
        window.isExpertOrAdmin = userRole === 'admin' || userRole === 'expert';
        
        // Показываем/скрываем кнопки удаления
        const deleteButtons = document.querySelectorAll('.delete-source');
        deleteButtons.forEach(button => {
            button.style.display = window.isExpertOrAdmin ? 'inline-block' : 'none';
        });
    });

    // Обработка удаления источника
    document.addEventListener('click', async function(e) {
        if (e.target.classList.contains('delete-source')) {
            const fullId = e.target.dataset.id;
            // Извлекаем короткий ID из полного URI (после последнего _)
            const sourceId = fullId.split('_').pop();
            const sourceTitle = e.target.dataset.title;
            
            if (confirm(`Вы уверены, что хотите удалить источник "${sourceTitle}"?`)) {
                try {
                    const response = await fetch(`/sources/${sourceId}`, {
                        method: 'DELETE',
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    });
                    
                    if (response.ok) {
                        // Удаляем карточку источника из DOM
                        e.target.closest('.source-card').remove();
                        alert('Источник успешно удален');
                    } else {
                        const data = await response.json();
                        alert(data.detail || 'Ошибка при удалении источника');
                    }
                } catch (error) {
                    console.error('Error deleting source:', error);
                    alert('Ошибка при удалении источника');
                }
            }
        }
    });
    </script>
</body>
</html>